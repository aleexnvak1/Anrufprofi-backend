<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard – anrufprofi.de</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-cyan-50 to-white min-h-screen font-sans">

  <script>
    if (localStorage.getItem('admin') !== 'true') {
      window.location.href = '/adminpassword.html';
    }
  </script>

  <div id="app" class="flex flex-col min-h-screen">
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-indigo-600 via-cyan-500 to-pink-400 shadow-lg px-4 py-4 sticky top-0 z-20">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <a href="/admin-dashboard.html" class="flex items-center gap-2 text-2xl font-bold text-white">
          <!-- SVG Logo/Icon -->
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16.8 3.2A9 9 0 1 1 12 21a9 9 0 0 1 4.8-17.8z"/>
            <circle cx="12" cy="12" r="4" fill="#fff" />
          </svg>
          anrufprofi.de <span class="hidden sm:inline">Admin</span>
        </a>
        <div class="flex gap-2 text-sm">
          <a href="/admin-dashboard.html" class="px-4 py-2 rounded-md font-medium text-white/80 hover:bg-white/10 transition">Anfragen</a>
          <a href="/clients.html" class="px-4 py-2 rounded-md font-medium text-white/80 hover:bg-white/10 transition">Kundenliste</a>
          <a href="/create-client.html" class="px-4 py-2 rounded-md font-medium text-white/80 hover:bg-white/10 transition">Kunden anlegen</a>
          <a href="/adminpassword.html" class="px-4 py-2 rounded-md font-medium text-pink-200 hover:text-white hover:bg-pink-500/40 transition">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <main class="flex-grow px-4 py-8 space-y-12 max-w-7xl mx-auto">
      <!-- Statistiken -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="bg-gradient-to-r from-indigo-100 via-indigo-50 to-white rounded-2xl p-6 shadow-md hover:shadow-lg transition flex items-center gap-4">
          <div class="bg-indigo-500 text-white rounded-full p-3 shadow w-12 h-12 flex items-center justify-center">
            <!-- Inbox Icon -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 0 0 2.22 0L21 8m-9 13V5" />
            </svg>
          </div>
          <div>
            <div class="text-sm text-indigo-500 font-semibold">Gesamtanfragen</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total }}</div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-yellow-100 via-white to-white rounded-2xl p-6 shadow-md hover:shadow-lg transition flex items-center gap-4">
          <div class="bg-yellow-400 text-white rounded-full p-3 shadow w-12 h-12 flex items-center justify-center">
            <!-- Hourglass Icon -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 4v4c0 2.21 1.79 4 4 4s4-1.79 4-4V4m-8 16v-4c0-2.21 1.79-4 4-4s4 1.79 4 4v4" />
            </svg>
          </div>
          <div>
            <div class="text-sm text-yellow-500 font-semibold">Offene Anfragen</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.open }}</div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-green-100 via-white to-white rounded-2xl p-6 shadow-md hover:shadow-lg transition flex items-center gap-4">
          <div class="bg-green-500 text-white rounded-full p-3 shadow w-12 h-12 flex items-center justify-center">
            <!-- Checkmark Icon -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <div class="text-sm text-green-500 font-semibold">Erledigt</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.done }}</div>
          </div>
        </div>
      </div>

      <!-- Tabelle -->
      <div class="overflow-x-auto">
        <h2 class="text-2xl font-bold mb-6 text-indigo-700 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 8l7.89 5.26a2 2 0 0 0 2.22 0L21 8m-9 13V5" />
          </svg>
          Kontaktanfragen
        </h2>
        <table class="min-w-full bg-white/90 shadow-xl rounded-2xl overflow-hidden text-base">
          <thead class="bg-gradient-to-r from-indigo-100 via-cyan-50 to-white text-indigo-700">
            <tr>
              <th class="py-4 px-4 font-semibold">Name</th>
              <th class="py-4 px-4 font-semibold">E-Mail</th>
              <th class="py-4 px-4 font-semibold">Nachricht</th>
              <th class="py-4 px-4 font-semibold">Status</th>
              <th class="py-4 px-4 font-semibold text-center">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="req in requests" :key="req.id" class="border-t border-gray-100 hover:bg-cyan-50 transition">
              <td class="py-3 px-4">{{ req.name }}</td>
              <td class="py-3 px-4">{{ req.email }}</td>
              <td class="py-3 px-4 max-w-xs truncate" :title="req.message">{{ req.message }}</td>
              <td class="py-3 px-4">
                <span v-if="req.status === 'erledigt'"
                  class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                  Erledigt
                </span>
                <span v-else
                  class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700 border border-yellow-200">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 4v4c0 2.21 1.79 4 4 4s4-1.79 4-4V4" /></svg>
                  Offen
                </span>
              </td>
              <td class="py-3 px-4 flex gap-3 justify-center">
                <button v-if="req.status !== 'erledigt'"
                  @click="markAsDone(req.id)"
                  class="group bg-green-100 hover:bg-green-500/80 rounded-full p-2 transition"
                  title="Als erledigt markieren">
                  <svg class="w-5 h-5 text-green-600 group-hover:text-white" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <button @click="deleteRequest(req.id)"
                  class="group bg-pink-100 hover:bg-pink-500/80 rounded-full p-2 transition"
                  title="Löschen">
                  <svg class="w-5 h-5 text-pink-500 group-hover:text-white" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </td>
            </tr>
            <tr v-if="requests.length === 0">
              <td colspan="5" class="py-8 text-center text-gray-400">Noch keine Anfragen vorhanden.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <!-- Demo-Anfragen Übersicht -->
<section class="max-w-3xl mx-auto bg-white shadow rounded-xl p-6 mt-10">
  <h2 class="text-xl font-bold mb-6 text-blue-900 flex items-center gap-2">
    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M3 8l7.89 5.26a2 2 0 0 0 2.22 0L21 8m-9 13V5" />
    </svg>
    Demo-Anfragen
  </h2>
  <div id="demoList" class="space-y-4"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  // Supabase Konfiguration
  const supabase = supabase.createClient(
    'https://deine-supabase-url.supabase.co',
    'service-role-or-public-key' // im Adminbereich darf es service-role sein
  );

  // Demo-Anfragen laden und anzeigen
  async function loadDemoRequests() {
    const { data, error } = await supabase
      .from('demo_requests')
      .select('*')
      .order('created_at', {ascending: false});
    const container = document.getElementById('demoList');
    if (error) {
      container.innerHTML = '<div class="text-red-500">Fehler beim Laden</div>';
      return;
    }
    if (!data.length) {
      container.innerHTML = '<div class="text-gray-400">Keine Demo-Anfragen vorhanden.</div>';
      return;
    }
    container.innerHTML = data.map(req => `
      <div class="border rounded-lg px-4 py-4 bg-blue-50 flex flex-col gap-1 relative group">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <b>${req.name}</b>
            ${req.company ? '· <span class="text-sm text-gray-600">' + req.company + '</span>' : ''}
          </div>
          <span class="text-xs text-gray-400">${new Date(req.created_at).toLocaleString()}</span>
        </div>
        <div class="flex flex-wrap gap-6 my-2 text-gray-800">
          <span><i class="bi bi-telephone"></i> ${req.phone}</span>
          ${req.email ? `<span><i class="bi bi-envelope"></i> ${req.email}</span>` : ''}
          ${req.preferred_time ? `<span><i class="bi bi-calendar"></i> ${new Date(req.preferred_time).toLocaleString()}</span>` : ''}
        </div>
        ${req.notes ? `<div class="text-xs text-blue-800 italic border-l-4 border-blue-400 pl-2 mb-2">"${req.notes}"</div>` : ''}
        <div class="absolute right-4 top-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
          <button onclick="deleteDemoRequest('${req.id}')" class="bg-pink-100 hover:bg-pink-400/90 text-pink-600 hover:text-white rounded-full p-2" title="Löschen">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
  }
  loadDemoRequests();

  // Demo-Anfrage löschen
  async function deleteDemoRequest(id) {
    if (!confirm('Wirklich löschen?')) return;
    await supabase.from('demo_requests').delete().eq('id', id);
    loadDemoRequests();
  }
</script>


  <!-- Vue App -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      new Vue({
        el: '#app',
        data: {
          requests: [],
          stats: { total: 0, open: 0, done: 0 }
        },
        mounted() {
          this.fetchRequests();
        },
        methods: {
          async fetchRequests() {
            try {
              const res = await fetch('/api/requests');
              const data = await res.json();
              this.requests = data.map(r => ({
                ...r,
                status: r.status?.replace(/'/g, '')
              }));
              this.calculateStats();
            } catch (e) {
              console.error('Fehler:', e);
            }
          },
          calculateStats() {
            this.stats.total = this.requests.length;
            this.stats.open = this.requests.filter(r => r.status !== 'erledigt').length;
            this.stats.done = this.requests.filter(r => r.status === 'erledigt').length;
          },
          async markAsDone(id) {
            await fetch(`/api/requests/${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: 'erledigt' })
            });
            this.fetchRequests();
          },
          async deleteRequest(id) {
            await fetch(`/api/requests/${id}`, {
              method: 'DELETE'
            });
            this.fetchRequests();
          }
        }
      });
    });
  </script>
</body>
</html>
